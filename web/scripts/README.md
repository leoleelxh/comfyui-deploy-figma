# 数据库维护和清理脚本

本目录包含用于维护和清理 ComfyUI Deploy 系统数据库和存储的脚本。

## 历史图片数据清理脚本 (cleanup-image-data.js)

这个脚本用于安全地清理 Neon 数据库中的历史图片数据，同时保留用户信息、工作流信息和生成记录。主要用于减少数据库存储量，提高查询性能，降低存储成本。

### 安全设计

脚本设计遵循以下安全原则：

1. **保留核心数据**：保留所有用户信息、工作流信息和生成记录
2. **仅清理图片数据**：只清理图片的实际数据部分，保留元数据（如文件名、URL、尺寸等）
3. **选择性清理**：基于时间范围选择性地清理数据
4. **模拟运行模式**：提供干运行模式，可以预览将要进行的更改而不实际执行
5. **分步操作**：将数据库清理和存储清理分开操作，允许用户单独选择

### 前提条件

- Node.js 16 或更高版本
- 项目环境已正确配置（.env.local 文件）
- 对 Neon 数据库的读写权限
- 对 R2/S3 存储的读写权限（如需清理存储）

### 使用方法

```bash
# 切换到项目目录
cd /path/to/comfyui-deploy-figma/web

# 安装依赖（如果尚未安装）
npm install

# 模拟运行，查看将清理 30 天前的 1000 条数据
node scripts/cleanup-image-data.js --days 30 --limit 1000 --dryrun

# 实际清理 60 天前的 500 条数据
node scripts/cleanup-image-data.js --days 60 --limit 500
```

### 命令行参数

| 参数       | 描述                     | 默认值 |
| ---------- | ------------------------ | ------ |
| `--days`   | 清理多少天前的数据       | 30     |
| `--limit`  | 每次处理的记录数量限制   | 1000   |
| `--dryrun` | 模拟运行，不实际删除数据 | 不启用 |

### 注意事项

1. **备份数据**：在清理前强烈建议备份数据库和存储
2. **分批运行**：对于大型数据库，建议使用较小的 `--limit` 值并多次运行
3. **先测试**：始终先使用 `--dryrun` 模式查看脚本的行为
4. **图片可访问性**：清理后，之前生成的图片仍然可以通过已保存的 URL 访问
5. **存储清理谨慎操作**：清理存储中的实际文件是不可逆的操作，请谨慎决定

### 示例场景

#### 场景一：测试清理效果

```bash
# 模拟清理 14 天前的 100 条记录
node scripts/cleanup-image-data.js --days 14 --limit 100 --dryrun
```

#### 场景二：分批清理大量历史数据

```bash
# 第一批：清理 90 天前的 1000 条记录
node scripts/cleanup-image-data.js --days 90 --limit 1000

# 继续清理剩余数据
node scripts/cleanup-image-data.js --days 90 --limit 1000

# 继续直到没有更多数据需要清理
```

#### 场景三：周期性维护

```bash
# 每月清理 60 天前的数据
node scripts/cleanup-image-data.js --days 60
```

### 故障排除

如果在运行脚本时遇到问题：

1. **数据库连接错误**：检查 `.env.local` 中的 Neon 数据库连接配置
2. **存储访问错误**：验证 R2/S3 存储的访问凭证和权限
3. **内存不足**：使用更小的 `--limit` 值减少每次处理的数据量
4. **运行时错误**：检查日志输出，可能是数据结构变化导致的问题

### 实现细节

脚本内部实现了以下功能：

1. **数据库清理**：将 workflowRunOutputs 表中的图片数据替换为空对象，但保留元数据
2. **存储清理**：使用 AWS SDK 删除 R2/S3 存储中的物理文件
3. **安全检查**：验证时间范围和记录限制，避免误操作
4. **日志记录**：记录每一步操作和结果，便于审计

### 谨慎使用存储清理功能

特别提醒：存储清理功能会永久删除 R2/S3 中的物理文件。这些文件删除后：

1. 相关的 URL 将不再可用
2. 依赖这些图片的网页将显示空图片或错误
3. 无法恢复（除非有备份）

只有当你确定图片数据不再需要时，才考虑使用存储清理功能。

## 自动化数据清理脚本 (scheduled-cleanup.js)

这个脚本设计用于在定时任务(cron job)中运行，无需用户交互，可以自动清理历史图片数据，释放数据库和存储空间。

### 特点

1. **完全自动化**：无需用户交互，适合定时任务
2. **详细日志**：支持控制台和文件日志，便于追踪和审计
3. **可配置存储清理**：可选择是否同时清理存储中的物理文件
4. **安全机制**：默认保守行为，需要显式启用更激进的选项

### 使用方法

```bash
# 基本用法（清理30天前的500条记录，不清理存储）
node scripts/scheduled-cleanup.js

# 清理60天前的1000条记录，同时清理存储文件，并记录日志
node scripts/scheduled-cleanup.js --days 60 --limit 1000 --storage 1 --log /var/log/cleanup/cleanup.log
```

### 命令行参数

| 参数        | 描述                          | 默认值            |
| ----------- | ----------------------------- | ----------------- |
| `--days`    | 清理多少天前的数据            | 30                |
| `--limit`   | 每次处理的记录数量限制        | 500               |
| `--storage` | 是否清理存储文件 (0=否, 1=是) | 0                 |
| `--log`     | 日志文件路径                  | 无 (仅控制台输出) |

### 设置为定时任务

#### Linux/Unix (Cron)

1. 编辑 crontab:

   ```bash
   crontab -e
   ```

2. 添加定时任务 (每周一凌晨 3 点运行):
   ```
   0 3 * * 1 cd /path/to/comfyui-deploy-figma/web && /usr/bin/node scripts/scheduled-cleanup.js --days 60 --limit 500 --log /var/log/cleanup/cleanup-$(date +\%Y\%m\%d).log
   ```

#### Windows (Task Scheduler)

1. 创建批处理文件 `cleanup.bat`:

   ```bat
   @echo off
   cd /d "C:\path\to\comfyui-deploy-figma\web"
   node scripts/scheduled-cleanup.js --days 60 --limit 500 --log "C:\logs\cleanup-%date:~0,4%%date:~5,2%%date:~8,2%.log"
   ```

2. 使用 Windows 任务计划程序创建一个定时任务，运行这个批处理文件

### 部署最佳实践

1. **备份策略**：设置定时任务前，确保有可靠的备份策略
2. **逐步进行**：先从小批量清理开始，监控几次后再考虑增加清理范围
3. **日志轮转**：使用日期参数在日志文件名中，防止单个日志文件过大
4. **错误通知**：考虑添加失败时的通知机制（例如发送邮件）
5. **存储空间监控**：定期检查数据库和存储空间使用情况

### 安全考虑

1. **权限隔离**：运行脚本的用户应只有必要的数据库和存储读写权限
2. **日志安全**：确保日志不包含敏感信息，并适当保护日志文件
3. **谨慎存储清理**：生产环境使用时谨慎启用`--storage 1`选项

### 实现细节

脚本实现了完整的错误处理和日志记录功能：

1. **失败恢复**：单个记录处理失败不会影响整体执行
2. **资源管理**：正确关闭数据库连接和日志文件
3. **进度报告**：详细记录每个步骤的进度和结果
